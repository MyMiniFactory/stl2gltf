
<head>
    <meta charset="UTF-8">
</head>
<script async type="text/javascript" src="../a.out.js"></script>
<script type="text/javascript">
    function uploaded() {
        var uploadform = document.getElementById("fileuploadform");
        var filename = uploadform.files[0].name;
        var fr = new FileReader();
        fr.readAsDataURL(uploadform.files[0]);

        fr.onload = function (){
            var stl_name = filename;
            var number_indices = 0;
            let info = new Int32Array([
                0, // number indices
                0, // number vertices
                0, // indices bytelength
                0, // vertices bytelength
                0  // total bytelength
            ]);
            var info_heapBytes = _arrayToHeap(info);

            let boundary = new Float32Array([
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0
            ]);
            var boundary_heapBytes = _arrayToHeap(boundary);

            var data = atob(fr.result.split(",")[1]); // base64 to Uint8 for emscripten
            Module['FS_createDataFile'](".", stl_name, data, true, true);

            Module.ccall("make_bin", // c function name
                    undefined, // return
                    ["string", "number", "number"], // param
                    [stl_name, info_heapBytes.byteOffset, boundary_heapBytes.byteOffset]
            );

            info = new Int32Array(info_heapBytes.buffer, info_heapBytes.byteOffset, info.length);
            boundary = new Float32Array(boundary_heapBytes.buffer, boundary_heapBytes.byteOffset, boundary.length);

            const gltf_json = JSON.stringify(
                gltf_dict(info[4], info[2], info[2], info[3], info[0], info[1], ...boundary)
            );

            const out_bin_bytelength = info[4];

            const header_bytelength = 20;
            const scene_len = gltf_json.length;
            const padded_scene_len = ((scene_len+ 3) & ~3);
            const body_offset = padded_scene_len + header_bytelength;
            const file_no_bin_len = body_offset + 8;
            const file_len = file_no_bin_len + out_bin_bytelength;

            let glb = new Uint8Array(file_no_bin_len);
            glb[0] = 0x67; // g
            glb[1] = 0x6c; // l
            glb[2] = 0x54; // t
            glb[3] = 0x46; // f

            glb[4]  = ( 2 ) & 0xFF;
            glb[5]  = ( 2>>8 ) & 0xFF;
            glb[6] = ( 2>>16 ) & 0xFF;
            glb[7] = ( 2>>24 ) & 0xFF;

            glb[8]  = ( file_len ) & 0xFF;
            glb[9]  = ( file_len>>8 ) & 0xFF;
            glb[10] = ( file_len>>16 ) & 0xFF;
            glb[11] = ( file_len>>24 ) & 0xFF;
            glb[12] = ( padded_scene_len ) & 0xFF;
            glb[13] = ( padded_scene_len>>8 ) & 0xFF;
            glb[14] = ( padded_scene_len>>16 ) & 0xFF;
            glb[15] = ( padded_scene_len>>24 ) & 0xFF;

            // JSON
            glb[16] = 0x4A; // J
            glb[17] = 0x53; // S
            glb[18] = 0x4F; // O
            glb[19] = 0x4E; // N

            for (let i=0;i<gltf_json.length;i++) {
                glb[i+header_bytelength] = gltf_json.charCodeAt(i);
            }
            for (let i=0;i<padded_scene_len - scene_len;i++) {
                glb[i+scene_len+header_bytelength] = 0x20;
            }

            glb[body_offset  ] = ( out_bin_bytelength ) & 0xFF;
            glb[body_offset+1] = ( out_bin_bytelength>>8 ) & 0xFF;
            glb[body_offset+2] = ( out_bin_bytelength>>16 ) & 0xFF;
            glb[body_offset+3] = ( out_bin_bytelength>>24 ) & 0xFF;
            glb[body_offset+4] = 0x42; // B
            glb[body_offset+5] = 0x49; // I
            glb[body_offset+6] = 0x4E; // N
            glb[body_offset+7] = 0x00; //

            let out_bin = Module['FS_readFile']('out.bin');

            let blob = new Blob([glb, out_bin], {type: 'application/sla'});
            let url = window.URL.createObjectURL(blob);
            var download_button = document.getElementById('download');
            download_button.href = url;
            download_button.download = stl_name + ".glb";




        }
    }

    function _arrayToHeap(typedArray){
        var numBytes = typedArray.length * typedArray.BYTES_PER_ELEMENT;
        var ptr = Module._malloc(numBytes);
        var heapBytes = new Uint8Array(Module.HEAPU8.buffer, ptr, numBytes);
        heapBytes.set(new Uint8Array(typedArray.buffer));
        return heapBytes;
    }
    function _freeArray(heapBytes){
        Module._free(heapBytes.byteOffset);
    }

    function Uint8ToString(u8a){
      var CHUNK_SZ = 0x8000;
      var c = [];
      for (var i=0; i < u8a.length; i+=CHUNK_SZ) {
          c.push(String.fromCharCode.apply(null, u8a.subarray(i, i+CHUNK_SZ)));
        }
        return c.join("");
    }

    function gltf_dict(
        total_blength, indices_blength, vertices_boffset, vertices_blength,
        number_indices, number_vertices, minx, miny, minz, maxx, maxy, maxz
    ) {
        return {
            "scenes" : [
                {
                    "nodes" : [ 0 ]
                }
            ],
                "nodes" : [
                    {
                        "mesh" : 0
                    }
                ],
                "meshes" : [
                    {
                        "primitives" : [ {
                            "attributes" : {
                                "POSITION" : 1
                            },
                            "indices" : 0
                        } ]
                    }
                ],
                "buffers" : [
                    {
                        "byteLength" : total_blength
                    }
                ],
                "bufferViews" : [
                    {
                        "buffer" : 0,
                        "byteOffset" : 0,
                        "byteLength" : indices_blength,
                        "target" : 34963
                    },
                    {
                        "buffer" : 0,
                        "byteOffset" : vertices_boffset,
                        "byteLength" : vertices_blength,
                        "target" : 34962
                    }
                ],
                "accessors" : [
                    {
                        "bufferView" : 0,
                        "byteOffset" : 0,
                        "componentType" : 5125,
                        "count" : number_indices,
                        "type" : "SCALAR",
                        "max" : [ number_indices - 1 ],
                        "min" : [ 0 ]
                    },
                    {
                        "bufferView" : 1,
                        "byteOffset" : 0,
                        "componentType" : 5126,
                        "count" : number_vertices,
                        "type" : "VEC3",
                        "min" : [minx, miny, minx],
                        "max" : [maxx, maxy, maxz]
                    }
                ],
                "asset" : {
                    "version" : "2.0"
                }
        } // end of dict
    }

</script>

<html>
<head>
</head>
<input type="file" onChange="uploaded()" id="fileuploadform"/>

<body>
    <a id="download"><button>Click to Download GLB</button></a>
</body>
</html>
